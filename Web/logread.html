<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>æ¸¸æˆæ—¥å¿—åˆ†æå·¥å…·</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    .container {
      width: 100%;
      height: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }
    h1 {
      margin: 10px 20px;
    }
    .log-viewer {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin: 0;
      resize: vertical;
      min-height: 200px;
      position: relative;
      padding-left: 10px;  /* ç§»é™¤å®šä½æŒ‰é’®çš„ç©ºé—´ */
    }
    .filter-panel {
      padding: 10px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    .filter-panel button {
      padding: 5px 15px;
      margin-right: 10px;
      cursor: pointer;
    }
    .filter-panel select {
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid #ddd;
    }
    .filter-panel select:hover {
      border-color: #2196F3;
    }
    .log-header {
      margin-left: 30px;  /* è°ƒæ•´è¡¨å¤´çš„å·¦è¾¹è·ï¼Œä¸å†…å®¹å¯¹é½ */
      display: flex;
      gap: 5px;
      padding: 5px;
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: bold;
      font-family: monospace;
      padding: 3px 5px;
    }
    .log-header span {
      color: #495057;
    }
    .log-header .toggle-btn {
      min-width: 40px;
      text-align: center;
    }
    .log-header .log-index {
      min-width: 50px;
      text-align: right;
      padding-right: 10px;
    }
    .log-header .log-timestamp {
      min-width: 85px;
    }
    .log-header .log-frame {
      min-width: 40px;
      text-align: right;
      padding-right: 10px;
    }
    .log-header .log-type {
      min-width: 60px;
    }
    .log-header .log-category {
      min-width: 150px;
    }
    .log-header .log-message {
      flex: 1;
    }
    .log-item {
      padding: 3px 5px;
      border-bottom: 1px solid #eee;
      white-space: pre-wrap;
      word-break: break-all;
      display: flex;
      gap: 5px;
      font-family: monospace;
      box-sizing: border-box;
      align-items: flex-start;
      cursor: default;
      position: relative;
      /* æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…é‡ç»˜ */
      contain: layout style paint;
      /* ä¼˜åŒ–æ¸²æŸ“å±‚ */
      backface-visibility: hidden;
    }
    /* å¶æ•°è¡ŒèƒŒæ™¯è‰² */
    .log-item:nth-child(even) {
      background-color: #f8f9fa;
    }
    /* å¥‡æ•°è¡ŒèƒŒæ™¯è‰² */
    .log-item:nth-child(odd) {
      background-color: #ffffff;
    }
    .log-item:hover {
      background-color: #e3f2fd !important;
    }
    .log-timestamp {
      color: #666;
      min-width: 85px;
    }
    .log-type {
      min-width: 60px;
      font-weight: bold;
    }
    .log-type.Log {
      color: #2196F3;
    }
    .log-type.Warning {
      color: #FF9800;
    }
    .log-type.Error {
      color: #F44336;
    }
    .log-category {
      color: #4CAF50;
      min-width: 150px;
    }
    .log-message {
      flex: 1;
      color: #333;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      position: relative;
    }
    .log-message.multiline {
      position: relative;
      display: flex;
      align-items: flex-start;
    }
    /* JSONæ ¼å¼å’Œå¤šè¡Œå†…å®¹çš„æŠ˜å çŠ¶æ€ */
    .log-message.multiline.collapsed {
      overflow: hidden;
      cursor: pointer;
      max-width: 80%;
      position: relative;
    }
    
    /* ç½‘ç»œæ—¥å¿—æŠ˜å æ—¶å•è¡Œæ˜¾ç¤º */
    .log-message.multiline.collapsed[data-network="true"] {
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    
    /* æ™®é€šå¤šè¡Œå†…å®¹æŠ˜å æ—¶é™åˆ¶è¡Œæ•° */
    .log-message.multiline.collapsed[data-network="false"] {
      white-space: pre-wrap;
      word-break: break-all;
      overflow: hidden;
      line-height: 1.2;
      max-height: 3.6em; /* 3è¡Œçš„é«˜åº¦ */
      position: relative;
    }
    /* åˆ é™¤æ—§çš„å†…è”æŒ‰é’®æ ·å¼ */
    .log-message.multiline.collapsed[onclick]::before,
    .log-message.multiline.expanded[onclick]::before,
    .log-message.multiline.collapsed[onclick]::after,
    .log-message.multiline.expanded[onclick]::after {
      content: none;
    }
    /* æ·»åŠ å•ç‹¬çš„å±•å¼€/æ”¶èµ·æŒ‰é’®æ ·å¼ */
    .toggle-btn {
      min-width: 40px;
      text-align: center;
      cursor: pointer;
      color: #2196F3;
      font-size: 12px;
      padding: 5px 0;
      margin-right: 5px;
      border-left: 1px solid #eee;
      border-right: 1px solid #eee;
      background-color: #f9f9f9;
    }
    .toggle-btn:hover {
      background-color: #e3f2fd;
    }
    /* ç¡®ä¿å±•å¼€çŠ¶æ€çš„æ ·å¼ */
    .log-message.multiline.expanded {
      height: auto;
      max-height: none;
      white-space: pre-wrap;
      display: block; /* ä¿®æ”¹ä¸ºblockä»¥è§£å†³é«˜äº®å†…å®¹çš„æ’ç‰ˆé—®é¢˜ */
    }
    /* åˆ é™¤æ—§çš„å³ä¾§æŒ‰é’®æ ·å¼ */
    .log-message.multiline.collapsed[onclick]::after {
      content: none;
    }
    .log-message.multiline.expanded[onclick]::after {
      content: none;
    }
    /* ç¡®ä¿é«˜äº®æ–‡æœ¬ä¸ä¼šç ´åå¸ƒå±€ */
    .highlight {
      background-color: #fff176;
      border-radius: 2px;
      padding: 0 2px;
      margin: 0 -2px;
      display: inline; /* ç¡®ä¿é«˜äº®å†…å®¹ä¿æŒå†…è” */
    }
    .module-filter-container {
      display: inline-block;
      position: relative;
    }
    .module-filter-container input {
      padding: 5px 10px;
      border-radius: 3px;
      border: 1px solid #ddd;
      width: 200px;
    }
    .module-filter-container input:focus {
      border-color: #2196F3;
      outline: none;
    }
    .module-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .module-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }
    .module-suggestion-item:hover {
      background-color: #f5f5f5;
    }
    .module-suggestion-item.selected {
      background-color: #e3f2fd;
    }
    .virtual-list {
      position: absolute;
      top: 0;
      left: 10px;  /* è°ƒæ•´å·¦è¾¹è· */
      right: 0;
      z-index: 1;
      padding: 0 10px;
      /* æ€§èƒ½ä¼˜åŒ–ï¼šå¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
      will-change: transform;
      transform: translateZ(0);
    }
    .virtual-list-phantom {
      position: absolute;
      left: 10px;  /* è°ƒæ•´å·¦è¾¹è· */
      top: 0;
      right: 0;
      z-index: -1;
    }
    .info-panel {
      padding: 0 20px;
      background: #e3f2fd;
      color: #1976d2;
      font-size: 14px;
      display: flex;
      flex-direction: column;
    }
    .info-row {
      padding: 5px 0;
      display: flex;
      gap: 20px;
      align-items: center;
      border-bottom: 1px solid rgba(25, 118, 210, 0.1);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-panel span {
      display: inline-flex;
      align-items: center;
    }
    .basic-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .basic-info button {
      padding: 4px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #detailInfo {
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .session-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .session-selector select {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #1976d2;
      background: white;
      color: #1976d2;
      cursor: pointer;
    }
    .session-selector select:disabled {
      border-color: #ccc;
      color: #999;
      cursor: not-allowed;
    }
    .log-index {
      min-width: 50px;
      text-align: right;
      padding-right: 10px;
      color: #666;
      padding-top: 5px;  /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è·å¯¹é½ */
    }
    .session-info {
      margin-left: 10px;
      color: #1976d2;
      font-size: 13px;
      display: flex;
      gap: 15px;
    }
    #exportBtn {
      padding: 4px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    #exportBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #logFile {
      padding: 4px;
      border: 1px solid #1976d2;
      border-radius: 4px;
      color: #1976d2;
      cursor: pointer;
    }
    #logFile::-webkit-file-upload-button {
      padding: 4px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    #logFile:disabled {
      border-color: #ccc;
      color: #999;
      cursor: not-allowed;
    }
    #logFile:disabled::-webkit-file-upload-button {
      background: #ccc;
      cursor: not-allowed;
    }
    /* å¤é€‰æ¡†æ ·å¼ */
    .filter-panel label {
      cursor: pointer;
      user-select: none;
    }
    .filter-panel label:hover {
      color: #1976d2;
    }
    .filter-panel input[type="checkbox"] {
      cursor: pointer;
    }
    .filter-panel input[type="checkbox"]:disabled {
      cursor: not-allowed;
    }
    .filter-panel label:has(input[type="checkbox"]:disabled) {
      color: #999;
      cursor: not-allowed;
    }
    /* æ·»åŠ èšç„¦æ ·å¼ */
    .log-item.focused {
      background-color: #bbdefb !important;
      border: 1px solid #2196F3;
    }
    .locate-btn {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ¸¸æˆæ—¥å¿—åˆ†æå·¥å…·</h1>
    
    <div class="info-panel">
      <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="info-row">
        <span>å½“å‰æ—¥å¿—: <span id="totalLogs">0</span> æ¡</span>
        <span>æ–‡ä»¶æ—¥å¿—: <span id="fileLogs">--</span></span>
        <span>æ–‡ä»¶å¤§å°: <span id="fileSize">0</span></span>
        <span>ç½‘ç»œæ—¥å¿—: <span id="networkCount">0</span> æ¡</span>
        <span>é”™è¯¯æ—¥å¿—: <span id="errorCount">0</span> æ¡</span>
        <div class="session-selector">
          <select id="sessionSelect" onchange="switchSession()" disabled>
            <option value="">é€‰æ‹©ç™»å½•ä¼šè¯...</option>
          </select>
          <span class="session-info">
            <span id="sessionCount">å…± 0 æ¬¡ç™»å½•</span>
            <span id="currentSession">å½“å‰: --</span>
          </span>
        </div>
        <button id="downloadOriginal" style="display: none;" onclick="downloadOriginalFile()">ä¸‹è½½åŸå§‹æ–‡ä»¶</button>
      </div>
      <!-- ç¬¬äºŒè¡Œï¼šè¯¦ç»†ä¿¡æ¯ -->
      <div class="info-row basic-info">
        <span>æ¥æº: <span id="source">--</span></span>
        <span>ä¼šè¯è´¦å·ID: <span id="accountId">--</span></span>
        <span>ç‰ˆæœ¬: <span id="version">--</span></span>
        <span>æäº¤æ—¶å€™ç™»å½•ID: <span id="loginId">--</span></span>
        <span>æäº¤æ—¶é—´: <span id="logTime">--</span></span>
        <span>å¹³å°: <span id="platform">--</span></span>
        <span>è¯­è¨€: <span id="language">--</span></span>
        <span>ç¯å¢ƒ: <span id="isOnline">--</span></span>
        <button id="showDetailBtn" onclick="showDetailInfo()">æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</button>
      </div>
    </div>

    <div class="filter-panel">
      <select id="typeFilter" onchange="filterLogs()" disabled>
        <option value="All">ç½‘ç»œ&&æ™®é€š</option>
        <option value="Network">ç½‘ç»œæ—¥å¿—</option>
        <option value="Normal">æ™®é€šæ—¥å¿—</option>
      </select>
      <select id="logLevel" onchange="filterLogs()" disabled>
        <option value="All">All</option>
        <option value="Log">Log</option>
        <option value="Warning">Warning</option>
        <option value="Error">Error</option>
      </select>
      <div class="module-filter-container">
        <input type="text" 
          id="moduleFilter" 
          placeholder="è¾“å…¥æ¨¡å—åç§°ç­›é€‰"
          autocomplete="off"
          disabled>
        <div id="moduleSuggestions" class="module-suggestions"></div>
      </div>
      <input type="text" 
        id="contentFilter" 
        placeholder="æœç´¢æ—¥å¿—å†…å®¹"
        style="padding: 5px 10px; border-radius: 3px; border: 1px solid #ddd; width: 200px;"
        disabled
        autocomplete="off">
      <label style="margin-left: 5px; display: inline-flex; align-items: center; gap: 5px;">
        <input type="checkbox" id="showOnlyMatches" onchange="handleSearchOptionsChange()">
        <span>ä»…æ˜¾ç¤ºæœç´¢å†…å®¹</span>
      </label>
      <label style="margin-left: 10px; display: inline-flex; align-items: center; gap: 5px;">
        <input type="checkbox" id="expandAllByDefault" onchange="handleExpandAllChange()">
        <span>é»˜è®¤å…¨å±•å¼€</span>
      </label>
      <button id="prevMatch" onclick="findPrevMatch()" disabled style="margin-left: 5px;">ä¸Šä¸€ä¸ª</button>
      <button id="nextMatch" onclick="findNextMatch()" disabled style="margin-left: 5px;">ä¸‹ä¸€ä¸ª</button>
      <span id="matchInfo" style="margin-left: 10px; color: #666;"></span>
      <input type="file" 
        id="logFile" 
        onchange="handleFileSelect(event)" 
        accept=".txt"
        title="é€‰æ‹©æ—¥å¿—æ–‡ä»¶">
      <button id="exportBtn" onclick="exportLogs()" disabled>å¯¼å‡ºæ—¥å¿—</button>
    </div>

    <div class="log-header">
      <span class="log-index">#</span>
      <span class="log-timestamp">æ—¶é—´</span>
      <span class="log-frame">å¸§</span>
      <span class="log-type">ç±»å‹</span>
      <span class="log-category">æ¨¡å—</span>
      <span class="toggle-btn"></span>
      <span class="log-message">æ—¥å¿—å†…å®¹</span>
    </div>
    <div class="log-viewer" id="logViewer">
      <div class="virtual-list-phantom"></div>
      <div class="virtual-list"></div>
    </div>
  </div>

  <!-- è¯¦ç»†ä¿¡æ¯å¼¹çª— -->
  <div id="detailInfoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>è¯¦ç»†ä¿¡æ¯</h2>
      <div id="detailInfo"></div>
    </div>
  </div>

  <script>
    // æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å‘å¸ƒæ—¶æ›´æ–°
    const version = new Date().getTime();
    
    // æ€§èƒ½ç›‘æ§
    let performanceStats = {
      scrollEvents: 0,
      renderCalls: 0,
      lastScrollTime: 0,
      scrollDuration: 0
    };
    
    // ç›‘æ§æ»šåŠ¨æ€§èƒ½
    function monitorScrollPerformance() {
      const logViewer = document.getElementById('logViewer');
      if (!logViewer) return;
      
      let scrollStartTime = 0;
      let isScrolling = false;
      
      logViewer.addEventListener('scroll', () => {
        if (!isScrolling) {
          scrollStartTime = performance.now();
          isScrolling = true;
        }
        
        performanceStats.scrollEvents++;
        performanceStats.lastScrollTime = performance.now();
        
        // æ£€æµ‹æ»šåŠ¨ç»“æŸ
        clearTimeout(logViewer.scrollEndTimer);
        logViewer.scrollEndTimer = setTimeout(() => {
          isScrolling = false;
          performanceStats.scrollDuration = performance.now() - scrollStartTime;
          
          // åœ¨æ§åˆ¶å°è¾“å‡ºæ€§èƒ½ç»Ÿè®¡ï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ï¼‰
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Scroll Performance:', {
              duration: performanceStats.scrollDuration.toFixed(2) + 'ms',
              events: performanceStats.scrollEvents,
              avgEventTime: (performanceStats.scrollDuration / performanceStats.scrollEvents).toFixed(2) + 'ms'
            });
          }
        }, 100);
      });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ€§èƒ½ç›‘æ§
    document.addEventListener('DOMContentLoaded', () => {
      monitorScrollPerformance();
      
      // æ·»åŠ è°ƒè¯•åŠŸèƒ½ï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ï¼‰
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        window.testEmptyState = function() {
          console.log('Testing empty state...');
          displayLogs([]);
          totalLogsElement.textContent = '0';
        };
        
        window.testWithData = function() {
          console.log('Testing with sample data...');
          const sampleLogs = [
            {
              timestamp: '12:34:56:789',
              type: 'Log',
              frame: 1,
              category: 'Test',
              message: 'Sample log message',
              rawContent: '[!@#]12:34:56:789 [Log]: Sample log message'
            }
          ];
          displayLogs(sampleLogs);
          totalLogsElement.textContent = '1';
        };
        
        console.log('Debug functions available:');
        console.log('- testEmptyState(): Test empty state display');
        console.log('- testWithData(): Test with sample data');
      }
    });
  </script>
  <script>
    // åŠ¨æ€åŠ è½½è§£æå™¨è„šæœ¬
    const script = document.createElement('script');
    script.src = 'log-parser.js?v=' + new Date().getTime();
    script.onload = function() {
      console.log('âœ… log-parser.js åŠ è½½æˆåŠŸ');
      // åˆå§‹åŒ–è§£æå™¨
      initializeParser();
    };
    script.onerror = function() {
      console.error('âŒ log-parser.js åŠ è½½å¤±è´¥');
    };
    document.head.appendChild(script);
  </script>
  <script>
    // ä»URLè·å–æ—¥å¿—æ–‡ä»¶åœ°å€
    function getLogUrlFromParams() {
      const urlParams = new URLSearchParams(window.location.search);
      console.log("urlParams",urlParams);
      return urlParams.get('logurl');
    }

    // ä»URLåŠ è½½æ—¥å¿—æ–‡ä»¶
    async function loadLogFromUrl(url) {
      try {
        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
        document.getElementById('downloadOriginal').style.display = 'inline-block';
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
            // è·å–æ–‡ä»¶å¤§å°
        const contentLength = response.headers.get('content-length');
        if (contentLength) {
          const size = parseInt(contentLength);
          // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
          const fileSizeStr = formatFileSize(size);
          document.getElementById('fileSize').textContent = fileSizeStr;
        }
        const content = await response.text();
        // å…ˆè§£æä¼šè¯
        parseSessions(content);
      } catch (error) {
        console.error('åŠ è½½æ—¥å¿—æ–‡ä»¶å¤±è´¥:', error);
        alert('åŠ è½½æ—¥å¿—æ–‡ä»¶å¤±è´¥: ' + error.message);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥URLå‚æ•°
    document.addEventListener('DOMContentLoaded', () => {
      const logViewerElement = document.getElementById('logViewer');
      if (logViewerElement) {
        virtualScroll = new VirtualScroll(logViewerElement);
      }

      // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰æ—¥å¿—æ–‡ä»¶åœ°å€
      const logUrl = getLogUrlFromParams();
      if (logUrl) {
        loadLogFromUrl(logUrl);
      }
    });

    // å°†å…¨å±€å˜é‡å£°æ˜ç§»åˆ°æœ€å‰é¢
    let currentLogs = [];
    let allCategories = [];
    let searchTimer = null;  // ç”¨äºé˜²æŠ–
    let lastSearchTerm = ''; // ç¼“å­˜ä¸Šæ¬¡æœç´¢è¯
    let basicInfo = {};
    let detailInfo = {};
    let sessions = [];  // å­˜å‚¨æ‰€æœ‰ä¼šè¯
    let currentSessionIndex = -1;  // å½“å‰ä¼šè¯ç´¢å¼•
    let selectedOriginalIndex = -1; // è®°å½•é€‰ä¸­æ—¥å¿—åœ¨åŸå§‹æ•°ç»„ä¸­çš„ç´¢å¼•
    let currentMatchIndex = -1;  // å½“å‰åŒ¹é…é¡¹çš„ç´¢å¼•
    let matchedIndices = [];     // æ‰€æœ‰åŒ¹é…é¡¹çš„ç´¢å¼•æ•°ç»„
    let virtualScroll;  // å£°æ˜è™šæ‹Ÿæ»šåŠ¨å®ä¾‹

    // ä¿®æ”¹ VirtualScroll ç±»çš„æ„é€ å‡½æ•°
    class VirtualScroll {
      constructor(container, defaultItemHeight = 30) {
        if (!container) {
          console.error('Container element is required for VirtualScroll');
          return;
        }

        this.container = container;
        this.defaultItemHeight = defaultItemHeight;
        this.items = [];
        this.visibleItems = [];
        this.startIndex = 0;
        this.endIndex = 0;
        this.bufferSize = 20;
        this.expandedMessages = new Set();
        this.itemHeights = new Map(); // å­˜å‚¨æ¯ä¸ªé¡¹çš„å®é™…é«˜åº¦
        this.focusedIndex = -1;
        this.selectedIndex = -1;
        this._totalHeight = null; // æ·»åŠ æ€»é«˜åº¦ç¼“å­˜
        this._heightPrefixSum = []; // é«˜åº¦å‰ç¼€å’Œæ•°ç»„ï¼Œç”¨äºå¿«é€Ÿè®¡ç®—ä½ç½®
        this._lastScrollTop = 0; // è®°å½•ä¸Šæ¬¡æ»šåŠ¨ä½ç½®
        this._scrollDirection = 0; // æ»šåŠ¨æ–¹å‘ï¼š1å‘ä¸‹ï¼Œ-1å‘ä¸Šï¼Œ0é™æ­¢
        
        this.virtualList = container.querySelector('.virtual-list');
        this.phantom = container.querySelector('.virtual-list-phantom');
        
        // ç»‘å®šæ–¹æ³•
        this.onScroll = this.onScroll.bind(this);
        this.render = this.render.bind(this);
        this.updateVisibleItems = this.updateVisibleItems.bind(this);
        
        // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬
        this.container.addEventListener('scroll', this.onScroll);
        
        // åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹é‡é«˜åº¦çš„éšè—å…ƒç´ 
        this.measureElement = document.createElement('div');
        this.measureElement.style.position = 'absolute';
        this.measureElement.style.visibility = 'hidden';
        this.measureElement.style.width = this.virtualList.clientWidth + 'px';
        this.measureElement.style.pointerEvents = 'none';
        document.body.appendChild(this.measureElement);
        
        // åˆ›å»º ResizeObserver
        this.observer = new ResizeObserver(this.updateVisibleItems);
        this.observer.observe(container);
        
        // åˆå§‹åŒ–è¡Œé«˜æµ‹é‡å™¨å’Œç¼“å­˜
        this.lineHeightMeasurer = null;
        this.maxLengthCache = null;
        this.scrollTimer = null;
        this.averageExpandedHeight = this.defaultItemHeight * 4; // å±•å¼€é¡¹çš„å¹³å‡é«˜åº¦ä¼°ç®—
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜å¸¸ç”¨çš„è®¡ç®—ç»“æœ
        this._multilineCache = new Map(); // ç¼“å­˜å¤šè¡Œåˆ¤æ–­ç»“æœ
        this._renderCache = new Map(); // ç¼“å­˜æ¸²æŸ“ç»“æœ
        this._lastRenderItems = []; // ä¸Šæ¬¡æ¸²æŸ“çš„é¡¹ç›®
        
        // æ»šåŠ¨ä¼˜åŒ–
        this._isScrolling = false;
        this._scrollEndTimer = null;
        this._fastScrollThreshold = 100; // å¿«é€Ÿæ»šåŠ¨é˜ˆå€¼
      }

      // æ¸…ç†èµ„æº
      destroy() {
        if (this.observer) {
          this.observer.disconnect();
        }
        if (this.lineHeightMeasurer) {
          document.body.removeChild(this.lineHeightMeasurer);
        }
        if (this.measureElement) {
          document.body.removeChild(this.measureElement);
        }
        if (this.scrollTimer) {
          cancelAnimationFrame(this.scrollTimer);
        }
        if (this._scrollEndTimer) {
          clearTimeout(this._scrollEndTimer);
        }
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        this.container.removeEventListener('scroll', this.onScroll);
      }

      // æ¸…ç†é«˜åº¦ç¼“å­˜
      clearHeightCache() {
        this._totalHeight = null;
        this.itemHeights.clear();
        this._heightPrefixSum = [];
        this._multilineCache.clear();
        this._renderCache.clear();
        // æ¸…ç†æ»šåŠ¨å®šæ—¶å™¨
        if (this.scrollTimer) {
          cancelAnimationFrame(this.scrollTimer);
          this.scrollTimer = null;
        }
      }

      // ä¼˜åŒ–çš„å¤šè¡Œå†…å®¹åˆ¤æ–­ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰
      isMultilineContent(log) {
        const logKey = `${log.timestamp}_${log.category}_${log.message.length}`;
        if (this._multilineCache.has(logKey)) {
          return this._multilineCache.get(logKey);
        }
        
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ¢è¡Œç¬¦
        const lines = log.message.split('\n');
        if (lines.length > 3) {
          this._multilineCache.set(logKey, true);
          return true;
        }
        
        // 2. ç®€åŒ–é•¿åº¦åˆ¤æ–­ï¼Œé¿å…å¤æ‚çš„DOMæµ‹é‡
        const message = log.message.trim();
        if (!message) {
          this._multilineCache.set(logKey, false);
          return false;
        }
        
        // ä½¿ç”¨ç®€å•çš„å­—ç¬¦æ•°ä¼°ç®—ï¼Œé¿å…DOMæµ‹é‡
        const estimatedCharsPerLine = Math.floor((this.virtualList.clientWidth - 400) / 8); // å‡è®¾æ¯ä¸ªå­—ç¬¦8px
        const estimatedLines = Math.ceil(message.length / estimatedCharsPerLine);
        const result = estimatedLines > 3;
        
        this._multilineCache.set(logKey, result);
        return result;
      }

      // ä¼˜åŒ–çš„é«˜åº¦è®¡ç®—ï¼ˆå‡å°‘DOMæ“ä½œï¼‰
      measureItemHeight(log, index) {
        // æ£€æŸ¥ç¼“å­˜
        if (this.itemHeights.has(index)) {
          return this.itemHeights.get(index);
        }
        
        const isExpanded = this.expandedMessages.has(index);
        const isNetworkLog = log.category === 'NET_PROTO' || log.category === 'NET_SEND';
        const isMultiline = this.isMultilineContent(log);
        
        let height;
        
        // ç®€åŒ–é«˜åº¦è®¡ç®—é€»è¾‘
        if (isExpanded && (isNetworkLog || isMultiline)) {
          // å±•å¼€çŠ¶æ€ï¼šä½¿ç”¨ä¼°ç®—é«˜åº¦ï¼Œé¿å…DOMæµ‹é‡
          if (isNetworkLog) {
            // ç½‘ç»œæ—¥å¿—å±•å¼€æ—¶çš„ä¼°ç®—é«˜åº¦
            const lines = log.message.split('\n').length;
            height = Math.max(this.defaultItemHeight * 2, lines * 20 + 20);
          } else {
            // å¤šè¡Œå†…å®¹å±•å¼€æ—¶çš„ä¼°ç®—é«˜åº¦
            const estimatedLines = Math.ceil(log.message.length / 80); // å‡è®¾æ¯è¡Œ80å­—ç¬¦
            height = Math.max(this.defaultItemHeight * 2, estimatedLines * 20 + 20);
          }
        } else if (isMultiline && !isNetworkLog && !isExpanded) {
          // å¤šè¡Œå†…å®¹æŠ˜å æ—¶æ˜¾ç¤º3è¡Œ
          height = this.defaultItemHeight * 3;
        } else {
          // æ™®é€šæ—¥å¿—æˆ–æŠ˜å çš„ç½‘ç»œæ—¥å¿—
          height = this.defaultItemHeight;
        }
        
        // ç¼“å­˜é«˜åº¦
        this.itemHeights.set(index, height);
        return height;
      }

      // æ„å»ºé«˜åº¦å‰ç¼€å’Œæ•°ç»„ï¼ˆç”¨äºå¿«é€Ÿå®šä½ï¼‰
      buildHeightPrefixSum() {
        if (this._heightPrefixSum.length === this.items.length) {
          return; // å·²ç»æ„å»ºè¿‡äº†
        }
        
        this._heightPrefixSum = [0];
        for (let i = 0; i < this.items.length; i++) {
          const height = this.getItemHeight(i);
          this._heightPrefixSum[i + 1] = this._heightPrefixSum[i] + height;
        }
      }

      // ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½å¼€å§‹ç´¢å¼•
      findStartIndex(scrollTop) {
        if (!this.items.length) return 0;
        
        this.buildHeightPrefixSum();
        
        // äºŒåˆ†æŸ¥æ‰¾
        let left = 0;
        let right = this._heightPrefixSum.length - 1;
        let result = 0;
        
        while (left <= right) {
          const mid = Math.floor((left + right) / 2);
          if (this._heightPrefixSum[mid] <= scrollTop) {
            result = mid;
            left = mid + 1;
          } else {
            right = mid - 1;
          }
        }
        
        return Math.max(0, result - 1);
      }

      // ä¼˜åŒ–çš„å¯è§åŒºåŸŸæ›´æ–°
      updateVisibleItems() {
        const containerHeight = this.container.clientHeight;
        const scrollTop = this.container.scrollTop;
        
        if (!this.items.length) {
          // å¤„ç†ç©ºæ•°ç»„æƒ…å†µ
          this.visibleItems = [];
          this.startIndex = 0;
          this.endIndex = 0;
          this.phantom.style.height = '0px';
          this.virtualList.style.transform = 'translate3d(0, 0px, 0)';
          this.render();
          return;
        }
        
        // æ£€æµ‹æ»šåŠ¨æ–¹å‘å’Œé€Ÿåº¦
        const scrollDelta = scrollTop - this._lastScrollTop;
        this._scrollDirection = scrollDelta > 0 ? 1 : scrollDelta < 0 ? -1 : 0;
        const isFastScroll = Math.abs(scrollDelta) > this._fastScrollThreshold;
        this._lastScrollTop = scrollTop;
        
        // åŠ¨æ€è°ƒæ•´ç¼“å†²åŒºå¤§å°
        const expandedCount = this.expandedMessages.size;
        const baseBufSize = Math.ceil(containerHeight / this.defaultItemHeight);
        let bufferSize = Math.min(baseBufSize + Math.floor(expandedCount / 10), baseBufSize * 2);
        
        // å¿«é€Ÿæ»šåŠ¨æ—¶å¢åŠ ç¼“å†²åŒº
        if (isFastScroll) {
          bufferSize = Math.min(bufferSize * 2, 100);
        }
        
        // æ‰¾åˆ°å¼€å§‹ç´¢å¼•
        const idealStartIndex = this.findStartIndex(scrollTop);
        this.startIndex = Math.max(0, idealStartIndex - bufferSize);
        
        // è®¡ç®—ç»“æŸç´¢å¼•
        const targetHeight = containerHeight + (isFastScroll ? containerHeight * 2 : containerHeight);
        let endIndex = idealStartIndex;
        let accumulatedHeight = 0;
        
        while (accumulatedHeight < targetHeight && endIndex < this.items.length) {
          accumulatedHeight += this.getItemHeight(endIndex);
          endIndex++;
        }
        
        this.endIndex = Math.min(endIndex + bufferSize, this.items.length);
        
        // è·å–å¯è§é¡¹
        this.visibleItems = this.items.slice(this.startIndex, this.endIndex);
        
        // è®¡ç®—é¡¶éƒ¨åç§»
        const topOffset = this._heightPrefixSum[this.startIndex] || this.getTotalHeight(0, this.startIndex);
        
        // ä½¿ç”¨transform3då¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
        this.virtualList.style.transform = `translate3d(0, ${topOffset}px, 0)`;
        
        // æ›´æ–°æ€»é«˜åº¦
        const totalHeight = this._heightPrefixSum[this.items.length] || this.getTotalHeight(0, this.items.length);
        this.phantom.style.height = `${totalHeight}px`;
        
        this.render();
      }

      // è®¾ç½®æ•°æ®é¡¹
      setItems(items) {
        this.items = items;
        this.expandedMessages.clear();
        this.clearHeightCache();
        
        // å¦‚æœæ˜¯ç©ºæ•°ç»„ï¼Œé‡ç½®æ»šåŠ¨ä½ç½®
        if (items.length === 0) {
          this.container.scrollTop = 0;
        }
        
        this.updateVisibleItems();
      }

      // ä¼˜åŒ–çš„æ»šåŠ¨äº‹ä»¶å¤„ç†
      onScroll() {
        // æ ‡è®°æ­£åœ¨æ»šåŠ¨
        this._isScrolling = true;
        
        // æ¸…é™¤æ»šåŠ¨ç»“æŸå®šæ—¶å™¨
        if (this._scrollEndTimer) {
          clearTimeout(this._scrollEndTimer);
        }
        
        // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹æ›´æ–°
        if (this.scrollTimer) {
          return;
        }
        
        this.scrollTimer = requestAnimationFrame(() => {
          this.updateVisibleItems();
          this.scrollTimer = null;
        });
        
        // è®¾ç½®æ»šåŠ¨ç»“æŸæ£€æµ‹
        this._scrollEndTimer = setTimeout(() => {
          this._isScrolling = false;
          // æ»šåŠ¨ç»“æŸåå¯ä»¥åšä¸€äº›æ¸…ç†å·¥ä½œ
        }, 150);
      }

      // æ·»åŠ  setSelectedIndex æ–¹æ³•
      setSelectedIndex(index) {
        this.selectedIndex = index;
        this.render();
      }

      // æ·»åŠ  setFocusedIndex æ–¹æ³•
      setFocusedIndex(index) {
        this.focusedIndex = index;
        this.render();
      }

      // æ·»åŠ  scrollToIndex æ–¹æ³•
      scrollToIndex(index, position = 'center') {
        if (index < 0 || index >= this.items.length) return;
        
        this.buildHeightPrefixSum();
        const targetOffset = this._heightPrefixSum[index];
        const itemHeight = this.getItemHeight(index);
        const containerHeight = this.container.clientHeight;
        
        switch (position) {
          case 'top':
            this.container.scrollTop = targetOffset;
            break;
          case 'bottom':
            this.container.scrollTop = targetOffset - containerHeight + itemHeight;
            break;
          case 'oneThird':
            this.container.scrollTop = targetOffset - (containerHeight / 3);
            break;
          default: // center
            this.container.scrollTop = targetOffset - (containerHeight / 2) + (itemHeight / 2);
        }
      }

      // è·å–æŒ‡å®šèŒƒå›´å†…æ‰€æœ‰é¡¹çš„æ€»é«˜åº¦
      getTotalHeight(startIndex, endIndex) {
        if (this._heightPrefixSum.length > 0) {
          return this._heightPrefixSum[endIndex] - this._heightPrefixSum[startIndex];
        }
        
        // å›é€€åˆ°åŸå§‹è®¡ç®—æ–¹æ³•
        let height = 0;
        for (let i = startIndex; i < endIndex; i++) {
          height += this.getItemHeight(i);
        }
        return height;
      }

      // è·å–å•ä¸ªé¡¹çš„é«˜åº¦
      getItemHeight(index) {
        if (this.itemHeights.has(index)) {
          return this.itemHeights.get(index);
        }
        
        // æ™ºèƒ½é¢„ä¼°
        if (this.expandedMessages.has(index)) {
          return this.averageExpandedHeight;
        }
        
        const log = this.items[index];
        if (log) {
          const isNetworkLog = log.category === 'NET_PROTO' || log.category === 'NET_SEND';
          const isMultiline = this.isMultilineContent(log);
          if (isNetworkLog || isMultiline) {
            return this.defaultItemHeight * 1.2;
          }
        }
        
        return this.defaultItemHeight;
      }

      // æ·»åŠ  findStartIndex æ–¹æ³•
      findStartIndex(scrollTop) {
        if (!this.items.length) return 0;
        
        this.buildHeightPrefixSum();
        
        // äºŒåˆ†æŸ¥æ‰¾
        let left = 0;
        let right = this._heightPrefixSum.length - 1;
        let result = 0;
        
        while (left <= right) {
          const mid = Math.floor((left + right) / 2);
          if (this._heightPrefixSum[mid] <= scrollTop) {
            result = mid;
            left = mid + 1;
          } else {
            right = mid - 1;
          }
        }
        
        return Math.max(0, result - 1);
      }

      // æ¸²æŸ“å•ä¸ªæ—¥å¿—é¡¹
      renderLogItem(log, globalIndex, isExpanded) {
        const message = log.message.trim();
        const isFocused = globalIndex === this.focusedIndex;
        const isSelected = globalIndex === this.selectedIndex;
        
        const isNetworkLog = log.category === 'NET_PROTO' || log.category === 'NET_SEND';
        const isMultiline = this.isMultilineContent(log);
        const canToggle = isNetworkLog || isMultiline;
        
        const messageClass = canToggle ? 
          `log-message multiline ${isExpanded ? 'expanded' : 'collapsed'}` : 
          'log-message';
          
        const searchTerm = lastSearchTerm;
        
        // ä¼˜åŒ–é«˜äº®é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„å¤„ç†
        let displayMessage;
        if (searchTerm && message.toLowerCase().includes(searchTerm.toLowerCase())) {
          // åªæœ‰åœ¨ç¡®å®åŒ…å«æœç´¢è¯æ—¶æ‰è¿›è¡Œé«˜äº®å¤„ç†
          if (canToggle && isExpanded) {
            displayMessage = this.highlightTextOptimized(message, searchTerm);
          } else if (canToggle && !isExpanded) {
            // æŠ˜å çŠ¶æ€ä¸‹çš„æ¶ˆæ¯å¤„ç†
            if (isMultiline && !isNetworkLog) {
              const lines = message.split('\n');
              if (lines.length > 3) {
                const previewLines = lines.slice(0, 3);
                displayMessage = this.highlightTextOptimized(previewLines.join('\n') + '...', searchTerm);
              } else {
                // é•¿å†…å®¹æˆªæ–­
                const maxLength = 300; // ä½¿ç”¨å›ºå®šé•¿åº¦ï¼Œé¿å…å¤æ‚è®¡ç®—
                if (message.length > maxLength) {
                  displayMessage = this.highlightTextOptimized(message.substring(0, maxLength) + '...', searchTerm);
                } else {
                  displayMessage = this.highlightTextOptimized(message, searchTerm);
                }
              }
            } else {
              displayMessage = this.highlightTextOptimized(message, searchTerm);
            }
          } else {
            displayMessage = this.highlightTextOptimized(message, searchTerm);
          }
        } else {
          // æ²¡æœ‰æœç´¢è¯æˆ–ä¸åŒ¹é…æ—¶ï¼Œç›´æ¥å¤„ç†æ¶ˆæ¯
          if (canToggle && !isExpanded) {
            if (isMultiline && !isNetworkLog) {
              const lines = message.split('\n');
              if (lines.length > 3) {
                displayMessage = this.escapeHtml(lines.slice(0, 3).join('\n') + '...');
              } else {
                const maxLength = 300;
                displayMessage = message.length > maxLength ? 
                  this.escapeHtml(message.substring(0, maxLength) + '...') : 
                  this.escapeHtml(message);
              }
            } else {
              displayMessage = this.escapeHtml(message);
            }
          } else {
            displayMessage = this.escapeHtml(message);
          }
        }

        // æ·»åŠ å±•å¼€/æ”¶èµ·æŒ‰é’®
        const toggleBtn = canToggle ? 
          `<span class="toggle-btn" onclick="toggleMessage(${globalIndex})">${isExpanded ? '[æ”¶èµ·]' : '[å±•å¼€]'}</span>` : 
          `<span class="toggle-btn"></span>`;

        return `
          <div class="log-item${isFocused ? ' focused' : ''}${isSelected ? ' selected' : ''}"
               data-index="${globalIndex}">
            <span class="log-index">${globalIndex + 1}</span>
            <span class="log-timestamp">${log.timestamp}</span>
            ${this.getFrameInfoOptimized(log)}
            <span class="log-type ${log.type}">${log.type}</span>
            <span class="log-category">${log.category}</span>
            ${toggleBtn}
            <span class="${messageClass}" 
                  data-index="${globalIndex}"
                  data-network="${isNetworkLog ? 'true' : 'false'}">${displayMessage}</span>
          </div>
        `;
      }

      // ä¼˜åŒ–çš„é«˜äº®æ–‡æœ¬æ–¹æ³•
      highlightTextOptimized(text, searchTerm) {
        if (!searchTerm || !text) return this.escapeHtml(text);
        
        try {
          // ä½¿ç”¨æ›´ç®€å•çš„æ›¿æ¢æ–¹æ³•
          const escapedText = this.escapeHtml(text);
          const escapedSearchTerm = this.escapeHtml(searchTerm).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
          
          return escapedText.replace(regex, '<span class="highlight">$1</span>');
        } catch (e) {
          console.error('Highlight error:', e);
          return this.escapeHtml(text);
        }
      }

      // HTMLè½¬ä¹‰æ–¹æ³•
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ä¼˜åŒ–çš„å¸§ä¿¡æ¯è·å–
      getFrameInfoOptimized(log) {
        return `<span class="log-frame">${log.frame}</span>`;
      }

      // æ¸²æŸ“å¯è§åŒºåŸŸ
      render() {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
        const currentItemsKey = this.visibleItems.map(item => `${item.timestamp}_${item.category}`).join(',');
        const expandedKey = Array.from(this.expandedMessages).sort().join(',');
        const renderKey = `${currentItemsKey}_${expandedKey}_${this.focusedIndex}_${this.selectedIndex}_${this.items.length}`;
        
        if (this._lastRenderKey === renderKey && this.items.length > 0) {
          return; // æ— éœ€é‡æ–°æ¸²æŸ“ï¼ˆä½†ç©ºæ•°ç»„æ—¶å¿…é¡»æ¸²æŸ“ï¼‰
        }
        this._lastRenderKey = renderKey;
        
        // å¤„ç†ç©ºæ•°æ®æƒ…å†µ
        if (this.items.length === 0) {
          this.virtualList.innerHTML = `
            <div class="empty-state" style="
              text-align: center; 
              color: #999; 
              padding: 40px 20px;
              font-size: 16px;
              background: #f8f9fa;
              border-radius: 8px;
              margin: 20px;
              border: 2px dashed #dee2e6;
            ">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
              <div style="font-weight: 500; margin-bottom: 8px;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—</div>
              <div style="font-size: 14px; color: #6c757d;">è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–é€‰æ‹©å…¶ä»–æ—¥å¿—ç±»å‹</div>
            </div>
          `;
          return;
        }
        
        // æ‰¹é‡æ¸²æŸ“
        const fragment = document.createDocumentFragment();
        const tempDiv = document.createElement('div');
        
        const htmlContent = this.visibleItems.map((log, index) => {
          const globalIndex = this.startIndex + index;
          return this.renderLogItem(log, globalIndex, this.expandedMessages.has(globalIndex));
        }).join('');
        
        tempDiv.innerHTML = htmlContent;
        while (tempDiv.firstChild) {
          fragment.appendChild(tempDiv.firstChild);
        }
        
        // ä¸€æ¬¡æ€§æ›¿æ¢å†…å®¹
        this.virtualList.innerHTML = '';
        this.virtualList.appendChild(fragment);
      }

      // åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
      toggleExpanded(index) {
        const log = this.items[index];
        if (!log) return;
        
        // è®°å½•å½“å‰çŠ¶æ€
        const currentScrollTop = this.container.scrollTop;
        const wasExpanded = this.expandedMessages.has(index);
        const oldHeight = this.getItemHeight(index);
        
        // åˆ‡æ¢å±•å¼€çŠ¶æ€
        if (wasExpanded) {
          this.expandedMessages.delete(index);
        } else {
          this.expandedMessages.add(index);
        }
        
        // æ¸…ç†å½“å‰é¡¹çš„é«˜åº¦ç¼“å­˜
        this.itemHeights.delete(index);
        // é‡å»ºé«˜åº¦å‰ç¼€å’Œ
        this._heightPrefixSum = [];
        
        // é‡æ–°æµ‹é‡é«˜åº¦
        const newHeight = this.measureItemHeight(log, index);
        const heightDelta = newHeight - oldHeight;
        
        // å¦‚æœç›®æ ‡é¡¹åœ¨å½“å‰è§†å£ä¸Šæ–¹ï¼Œè°ƒæ•´æ»šåŠ¨ä½ç½®
        if (heightDelta !== 0) {
          this.buildHeightPrefixSum();
          const offsetBefore = this._heightPrefixSum[index];
          
          if (offsetBefore < currentScrollTop) {
            const newScrollTop = currentScrollTop + heightDelta;
            this.container.scrollTop = newScrollTop;
          }
        }
        
        // å»¶è¿Ÿæ›´æ–°ï¼Œé¿å…æ»šåŠ¨äº‹ä»¶å†²çª
        requestAnimationFrame(() => {
          this.updateVisibleItems();
          
          // å¦‚æœç›®æ ‡é¡¹ä¸åœ¨å¯è§åŒºåŸŸï¼Œæ»šåŠ¨åˆ°è¯¥é¡¹
          if (index < this.startIndex || index >= this.endIndex) {
            requestAnimationFrame(() => {
              this.scrollToIndex(index, 'oneThird');
            });
          }
        });
      }
    }

    let parser = null;  // å»¶è¿Ÿåˆå§‹åŒ–
    
    // åˆå§‹åŒ–è§£æå™¨å‡½æ•°
    function initializeParser() {
      try {
        console.log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ–LogParser...');
        parser = new LogParser();
        console.log('âœ… LogParseråˆå§‹åŒ–æˆåŠŸ');
        
        // å¦‚æœæœ‰URLå‚æ•°ï¼Œè‡ªåŠ¨åŠ è½½æ—¥å¿—
        const logUrl = getLogUrlFromParams();
        if (logUrl) {
          console.log('ğŸ” æ£€æµ‹åˆ°URLå‚æ•°ï¼Œè‡ªåŠ¨åŠ è½½æ—¥å¿—:', logUrl);
          loadLogFromUrl(logUrl);
        }
      } catch (error) {
        console.error('âŒ LogParseråˆå§‹åŒ–å¤±è´¥:', error);
      }
    }
    const logViewer = document.getElementById('logViewer');
    const logLevelSelect = document.getElementById('logLevel');
    const moduleFilter = document.getElementById('moduleFilter');
    const typeFilter = document.getElementById('typeFilter');
    const moduleSuggestions = document.getElementById('moduleSuggestions');
    const contentFilter = document.getElementById('contentFilter');
    const fileInput = document.getElementById('logFile');
    const totalLogsElement = document.getElementById('totalLogs');
    const fileSizeElement = document.getElementById('fileSize');

    // å¯ç”¨æ‰€æœ‰æ§ä»¶
    function enableControls() {
      typeFilter.disabled = false;
      logLevelSelect.disabled = false;
      moduleFilter.disabled = false;
      contentFilter.disabled = false;
      document.getElementById('exportBtn').disabled = false;
      document.getElementById('showOnlyMatches').disabled = false;
      document.getElementById('expandAllByDefault').disabled = false;
    }

    // é‡ç½®æ‰€æœ‰ç­›é€‰å™¨
    function resetFilters() {
      typeFilter.value = 'All';
      logLevelSelect.value = 'All';
      moduleFilter.value = '';
      contentFilter.value = '';
      lastSearchTerm = '';
      document.getElementById('showOnlyMatches').checked = false;
      document.getElementById('expandAllByDefault').checked = false;
      moduleSuggestions.style.display = 'none';
      
      // æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—å¹¶å®šä½åˆ°é€‰ä¸­çš„æ—¥å¿—
      if (selectedOriginalIndex >= 0) {
        displayLogs(currentLogs);
        virtualScroll.setSelectedLog(selectedOriginalIndex);
      }
    }

    function handleFileSelect(event) {
      // å¦‚æœå–æ¶ˆé€‰æ‹©ï¼Œä¿æŒå½“å‰çŠ¶æ€
      if (!event.target.files || !event.target.files[0]) {
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        const prevFile = event.target.dataset.prevFile;
        if (prevFile) {
          event.target.value = prevFile;
        }
        return;
      }

      const file = event.target.files[0];
      
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      if (!file.name.toLowerCase().endsWith('.txt')) {
        alert('è¯·é€‰æ‹© .txt æ ¼å¼çš„æ—¥å¿—æ–‡ä»¶');
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        const prevFile = event.target.dataset.prevFile;
        if (prevFile) {
          event.target.value = prevFile;
        }
        return;
      }
      
      // ä¿å­˜å½“å‰é€‰æ‹©
      event.target.dataset.prevFile = event.target.value;
      
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      resetFilters();
      
      // éšè—ä¸‹è½½åŸå§‹æ–‡ä»¶æŒ‰é’®ï¼ˆå› ä¸ºç°åœ¨æ˜¯æœ¬åœ°æ–‡ä»¶ï¼‰
      document.getElementById('downloadOriginal').style.display = 'none';
      
      // æ¸…é™¤ URL å‚æ•°ä¸­çš„ logurl
      const url = new URL(window.location.href);
      url.searchParams.delete('logurl');
      window.history.replaceState({}, '', url);
      
      fileSizeElement.textContent = formatFileSize(file.size);
      
      // ç¦ç”¨æ‰€æœ‰æ§ä»¶
      typeFilter.disabled = true;
      logLevelSelect.disabled = true;
      moduleFilter.disabled = true;
      contentFilter.disabled = true;
      document.getElementById('exportBtn').disabled = true;
      document.getElementById('showOnlyMatches').disabled = true;
      document.getElementById('expandAllByDefault').disabled = true;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        // å…ˆè§£æä¼šè¯
        parseSessions(e.target.result);
      };
      
      reader.readAsText(file);
    }

    function getFrameInfo(log) {
      return `<span class="log-frame">${log.frame}</span>`;
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    // ä¼˜åŒ–çš„å…¨å±€é«˜äº®å‡½æ•°ï¼ˆä¿ç•™å‘åå…¼å®¹ï¼‰
    function highlightText(text, searchTerm) {
      if (!searchTerm || !text) return escapeHtml(text);
      
      try {
        // ä½¿ç”¨æ›´ç®€å•çš„æ›¿æ¢æ–¹æ³•
        const escapedText = escapeHtml(text);
        const escapedSearchTerm = escapeHtml(searchTerm).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
        
        return escapedText.replace(regex, '<span class="highlight">$1</span>');
      } catch (e) {
        console.error('Highlight error:', e);
        return escapeHtml(text);
      }
    }

    // å…¨å±€HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function displayLogs(logs) {
      virtualScroll.setItems(logs);
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦é»˜è®¤å…¨å±•å¼€
      const expandAll = document.getElementById('expandAllByDefault').checked;
      if (expandAll) {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿setItemså®Œæˆ
        setTimeout(() => {
          expandAllToggleableItems();
        }, 0);
      }
    }

    function toggleMessage(index) {
      virtualScroll.toggleExpanded(index);
    }

    // å¤„ç†æœç´¢é€‰é¡¹å˜åŒ–
    function handleSearchOptionsChange() {
      const showOnlyMatches = document.getElementById('showOnlyMatches').checked;
      if (showOnlyMatches) {
        // å¦‚æœå‹¾é€‰äº†"ä»…æ˜¾ç¤ºæœç´¢å†…å®¹"ï¼Œé‡æ–°åº”ç”¨è¿‡æ»¤
        filterLogs();
      } else {
        // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—ä½†ä¿æŒé«˜äº®
        displayLogs(currentLogs);
      }
      updateMatchNavigation();
    }

    // å¤„ç†é»˜è®¤å…¨å±•å¼€é€‰é¡¹å˜åŒ–
    function handleExpandAllChange() {
      const expandAll = document.getElementById('expandAllByDefault').checked;
      
      if (expandAll) {
        // å±•å¼€æ‰€æœ‰å¯å±•å¼€çš„å†…å®¹
        expandAllToggleableItems();
      } else {
        // æ”¶èµ·æ‰€æœ‰å†…å®¹
        collapseAllItems();
      }
    }

    // å±•å¼€æ‰€æœ‰å¯å±•å¼€çš„é¡¹ç›®
    function expandAllToggleableItems() {
      if (!virtualScroll || !virtualScroll.items) return;
      
      // æ‰¹é‡æ·»åŠ å±•å¼€çŠ¶æ€
      const newExpandedItems = new Set();
      virtualScroll.items.forEach((log, index) => {
        const isNetworkLog = log.category === 'NET_PROTO' || log.category === 'NET_SEND';
        const isMultiline = virtualScroll.isMultilineContent(log);
        
        if (isNetworkLog || isMultiline) {
          newExpandedItems.add(index);
        }
      });
      
      // ä¸€æ¬¡æ€§æ›´æ–°å±•å¼€çŠ¶æ€
      virtualScroll.expandedMessages = newExpandedItems;
      
      // æ¸…ç†é«˜åº¦ç¼“å­˜å¹¶é‡æ–°æ¸²æŸ“
      virtualScroll.clearHeightCache();
      virtualScroll.updateVisibleItems();
    }

    // æ”¶èµ·æ‰€æœ‰é¡¹ç›®
    function collapseAllItems() {
      if (!virtualScroll) return;
      
      // æ¸…ç©ºå±•å¼€çŠ¶æ€
      virtualScroll.expandedMessages.clear();
      
      // æ¸…ç†é«˜åº¦ç¼“å­˜å¹¶é‡æ–°æ¸²æŸ“
      virtualScroll.clearHeightCache();
      virtualScroll.updateVisibleItems();
    }

    // æ›´æ–°åŒ¹é…å¯¼èˆªçŠ¶æ€
    function updateMatchNavigation() {
      const searchTerm = contentFilter.value.trim();
      const prevButton = document.getElementById('prevMatch');
      const nextButton = document.getElementById('nextMatch');
      const matchInfo = document.getElementById('matchInfo');
      
      if (!searchTerm) {
        prevButton.disabled = true;
        nextButton.disabled = true;
        matchInfo.textContent = '';
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰å¯æœç´¢çš„é¡¹ç›®
      if (!virtualScroll || !virtualScroll.items || virtualScroll.items.length === 0) {
        prevButton.disabled = true;
        nextButton.disabled = true;
        currentMatchIndex = -1;
        matchInfo.textContent = 'æ— åŒ¹é…é¡¹';
        return;
      }

      // è·å–æ‰€æœ‰åŒ¹é…é¡¹çš„ç´¢å¼•
      matchedIndices = [];
      virtualScroll.items.forEach((log, index) => {
        if (log.message.toLowerCase().includes(searchTerm.toLowerCase())) {
          matchedIndices.push(index);
        }
      });

      const totalMatches = matchedIndices.length;
      if (totalMatches > 0) {
        prevButton.disabled = false;
        nextButton.disabled = false;
        if (currentMatchIndex === -1) {
          currentMatchIndex = 0;
        }
        matchInfo.textContent = `${currentMatchIndex + 1}/${totalMatches}`;
      } else {
        prevButton.disabled = true;
        nextButton.disabled = true;
        currentMatchIndex = -1;
        matchInfo.textContent = 'æ— åŒ¹é…é¡¹';
      }
    }

    // æŸ¥æ‰¾ä¸Šä¸€ä¸ªåŒ¹é…é¡¹
    function findPrevMatch() {
      if (matchedIndices.length === 0) return;
      
      currentMatchIndex = currentMatchIndex <= 0 ? 
        matchedIndices.length - 1 : currentMatchIndex - 1;
      
      const targetIndex = matchedIndices[currentMatchIndex];
      virtualScroll.setSelectedIndex(targetIndex);  // è®¾ç½®é€‰ä¸­çŠ¶æ€
      virtualScroll.scrollToIndex(targetIndex);
      updateMatchNavigation();
    }

    // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹
    function findNextMatch() {
      if (matchedIndices.length === 0) return;
      
      currentMatchIndex = currentMatchIndex >= matchedIndices.length - 1 ? 
        0 : currentMatchIndex + 1;
      
      const targetIndex = matchedIndices[currentMatchIndex];
      virtualScroll.setSelectedIndex(targetIndex);  // è®¾ç½®é€‰ä¸­çŠ¶æ€
      virtualScroll.scrollToIndex(targetIndex);
      updateMatchNavigation();
    }

    // ä¿®æ”¹ filterLogs å‡½æ•°ï¼Œè¿”å›ç­›é€‰åçš„æ•°æ®
    function filterLogs() {
      const selectedLevel = logLevelSelect.value;
      const moduleKeyword = moduleFilter.value.toLowerCase();
      const selectedType = typeFilter.value;
      const contentKeyword = contentFilter.value.trim().toLowerCase();
      const showOnlyMatches = document.getElementById('showOnlyMatches').checked;
      
      let filteredLogs = currentLogs;
      
      // åº”ç”¨ç±»å‹ç­›é€‰
      if (selectedType === 'Network') {
        filteredLogs = filteredLogs.filter(log => parser.isNetworkLog(log));
      } else if (selectedType === 'Normal') {
        filteredLogs = filteredLogs.filter(log => !parser.isNetworkLog(log));
      }
      
      // åº”ç”¨æ—¥å¿—ç­‰çº§ç­›é€‰
      if (selectedLevel !== 'All') {
        filteredLogs = filteredLogs.filter(log => log.type === selectedLevel);
      }
      
      // åº”ç”¨æ¨¡å—ç­›é€‰
      if (moduleKeyword) {
        filteredLogs = filteredLogs.filter(log => 
          log.category.toLowerCase().includes(moduleKeyword)
        );
      }
      
      // åº”ç”¨å†…å®¹æœç´¢
      if (contentKeyword) {
        lastSearchTerm = contentKeyword;
        if (showOnlyMatches) {
          filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(contentKeyword)
          );
        }
      } else {
        lastSearchTerm = '';
      }
      
      displayLogs(filteredLogs);
      
      // æ›´æ–°åŒ¹é…å¯¼èˆªçŠ¶æ€
      updateMatchNavigation();
      
      // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„æ—¥å¿—æ•°
      totalLogsElement.textContent = filteredLogs.length;

      return filteredLogs;  // è¿”å›ç­›é€‰åçš„æ•°æ®
    }

    // ä¿®æ”¹å†…å®¹æœç´¢çš„äº‹ä»¶å¤„ç†
    contentFilter.addEventListener('input', debounce(function() {
      // å½“æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œæ¸…é™¤æ‰€æœ‰çŠ¶æ€
      if (!this.value.trim()) {
        lastSearchTerm = '';
        currentMatchIndex = -1;
        matchedIndices = [];
        virtualScroll.setFocusedIndex(-1);  // æ¸…é™¤èšç„¦
        virtualScroll.setSelectedIndex(-1);  // æ¸…é™¤é€‰ä¸­çŠ¶æ€
      }
      filterLogs();
    }, 200));

    // å¤„ç†æ¨¡å—è¾“å…¥
    moduleFilter.addEventListener('input', function() {
      const value = this.value.toLowerCase();
      if (!value) {
        moduleSuggestions.style.display = 'none';
        filterLogs();
        return;
      }
      
      const matches = allCategories.filter(cat => 
        cat.toLowerCase().includes(value)
      );
      
      if (matches.length === 0) {
        moduleSuggestions.style.display = 'none';
        return;
      }
      
      moduleSuggestions.innerHTML = matches
        .map(cat => `
          <div class="module-suggestion-item" onclick="selectModule('${cat}')">${cat}</div>
        `).join('');
      
      moduleSuggestions.style.display = 'block';
      filterLogs();  // å®æ—¶è¿‡æ»¤
    });

    // é€‰æ‹©æ¨¡å—
    function selectModule(category) {
      moduleFilter.value = category;
      moduleSuggestions.style.display = 'none';
      filterLogs();
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®åˆ—è¡¨
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.module-filter-container')) {
        moduleSuggestions.style.display = 'none';
      }
    });

    // è§£æä¼šè¯
    function parseSessions(content) {
      if (!parser) {
        console.error('âŒ è§£æå™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•è§£æä¼šè¯');
        alert('è§£æå™¨æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      console.log('ğŸ“ å¼€å§‹è§£æä¼šè¯ï¼Œå†…å®¹é•¿åº¦:', content.length, 'å­—ç¬¦');
      
      const lines = content.split('\n');
      let sessionStart = -1;
      let currentSession = [];
      sessions = [];  // æ¸…ç©ºæ—§ä¼šè¯
      let headerLines = [];  // å­˜å‚¨å¤´éƒ¨ä¿¡æ¯
      
      // å…ˆæ”¶é›†å¤´éƒ¨ä¿¡æ¯
      let i = 0;
      while (i < lines.length && !lines[i].startsWith('[!@#]')) {
        if (lines[i].trim()) {
          headerLines.push(lines[i]);
        }
        i++;
      }
      
      // æŸ¥æ‰¾æ‰€æœ‰ä¼šè¯
      for (; i < lines.length; i++) {
        const line = lines[i];
        if (line.includes('[FileAppender] Log started')) {
          if (sessionStart !== -1) {
            // ä¿å­˜ä¸Šä¸€ä¸ªä¼šè¯
            sessions.push({
              start: sessionStart,
              end: i - 1,
              lines: [...headerLines, ...currentSession]  // åŒ…å«å¤´éƒ¨ä¿¡æ¯
            });
          }
          sessionStart = i;
          currentSession = [line];
        } else if (sessionStart !== -1) {
          currentSession.push(line);
        }
      }
      
      // ä¿å­˜æœ€åä¸€ä¸ªä¼šè¯
      if (sessionStart !== -1) {
        sessions.push({
          start: sessionStart,
          end: lines.length - 1,
          lines: [...headerLines, ...currentSession]  // åŒ…å«å¤´éƒ¨ä¿¡æ¯
        });
      }

      console.log(`ğŸ¯ ä¼šè¯è§£æå®Œæˆï¼Œå…±æ‰¾åˆ° ${sessions.length} ä¸ªä¼šè¯`);
      sessions.forEach((session, index) => {
        console.log(`  ä¼šè¯ ${index + 1}: ${session.lines.length} è¡Œå†…å®¹`);
      });
      
      // æ›´æ–°ä¼šè¯é€‰æ‹©å™¨
      updateSessionSelector();
      
      // é»˜è®¤åŠ è½½æœ€åä¸€ä¸ªä¼šè¯
      if (sessions.length > 0) {
        currentSessionIndex = sessions.length - 1;
        console.log(`ğŸš€ è‡ªåŠ¨åŠ è½½æœ€åä¸€ä¸ªä¼šè¯: ç¬¬ ${currentSessionIndex + 1} æ¬¡`);
        loadSession(currentSessionIndex);
        // æ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯
        document.getElementById('currentSession').textContent = 
          `å½“å‰: ç¬¬ ${currentSessionIndex + 1} æ¬¡`;
        document.getElementById('sessionCount').textContent = 
          `å…± ${sessions.length} æ¬¡ç™»å½•`;
      } else {
        console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¼šè¯');
      }
    }

    // æ›´æ–°ä¼šè¯é€‰æ‹©å™¨
    function updateSessionSelector() {
      const select = document.getElementById('sessionSelect');
      const sessionCountElement = document.getElementById('sessionCount');
      const currentSessionElement = document.getElementById('currentSession');
      
      // å…ˆæ‰¾åˆ°æ¯ä¸ªä¼šè¯çš„ç¬¬ä¸€æ¡æ—¥å¿—æ—¶é—´ä½œä¸ºæ ‡è¯†
      const sessionOptions = sessions.map((session, index) => {
        // æŸ¥æ‰¾ç¬¬ä¸€æ¡æ—¥å¿—çš„æ—¶é—´æˆ³
        const firstLogMatch = session.lines.find(line => line.startsWith('[!@#]'));
        let sessionTime = `ä¼šè¯ ${index + 1}`;
        if (firstLogMatch) {
          const timeMatch = firstLogMatch.match(/\[!@#\](\d{2}:\d{2}:\d{2}:\d{3})/);
          if (timeMatch) {
            sessionTime = timeMatch[1];
          }
        }
        return `<option value="${index}" ${index === currentSessionIndex ? 'selected' : ''}>
          ${sessionTime}
        </option>`;
      });
      
      select.innerHTML = '<option value="">é€‰æ‹©ç™»å½•ä¼šè¯...</option>' + sessionOptions.join('');
      select.disabled = sessions.length === 0;
      
      // æ›´æ–°ä¼šè¯ç»Ÿè®¡ä¿¡æ¯
      sessionCountElement.textContent = `å…± ${sessions.length} æ¬¡ç™»å½•`;
      currentSessionElement.textContent = currentSessionIndex >= 0 ? 
        `å½“å‰: ç¬¬ ${currentSessionIndex + 1} æ¬¡` : 
        'å½“å‰: --';
    }

    // åˆ‡æ¢ä¼šè¯æ—¶ä¹Ÿæ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯
    function switchSession() {
      const select = document.getElementById('sessionSelect');
      const index = parseInt(select.value);
      if (index >= 0 && index < sessions.length) {
        currentSessionIndex = index;
        loadSession(index);
        document.getElementById('currentSession').textContent = 
          `å½“å‰: ç¬¬ ${index + 1} æ¬¡`;
      }
    }

    // åŠ è½½æŒ‡å®šä¼šè¯
    function loadSession(index) {
      if (!parser) {
        console.error('âŒ è§£æå™¨æœªåˆå§‹åŒ–');
        return;
      }
      
      const session = sessions[index];
      const content = session.lines.join('\n');
      
      console.log(`ğŸ” åŠ è½½ä¼šè¯ ${index + 1}, å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
      
      // é‡ç½®è§£æå™¨çŠ¶æ€
      parser.logs = [];
      parser.categories.clear();
      parser.networkLogs = [];
      parser.normalLogs = [];
      parser.battleLogs = [];
      parser.entityLogs = [];
      parser.errorLogs = [];
      parser.currentMultiLineLog = null;
      
      // è§£æåŸºæœ¬ä¿¡æ¯
      parseBasicInfo(content);
      
      // è§£ææ—¥å¿—
      console.log('ğŸ“Š å¼€å§‹è§£ææ—¥å¿—å†…å®¹...');
      parser.parseLogFile(content);
      currentLogs = parser.logs;
      allCategories = parser.getCategories();
      
      console.log(`âœ… è§£æå®Œæˆ: ${currentLogs.length} æ¡æ—¥å¿—, ${allCategories.length} ä¸ªæ¨¡å—`);
      console.log('æ¨¡å—åˆ—è¡¨:', allCategories);
      
      // è§£æè´¦å·ID
      parseAccountId(currentLogs);
      
      // æ›´æ–°æ˜¾ç¤º
      totalLogsElement.textContent = currentLogs.length;
      document.getElementById('networkCount').textContent = parser.networkLogs.length;
      document.getElementById('errorCount').textContent = parser.errorLogs.length;
      
      console.log('ğŸ¨ æ›´æ–°ç•Œé¢æ˜¾ç¤º...');
      enableControls();
      // é‡ç½®ç­›é€‰æ¡ä»¶
      resetFilters();
      displayLogs(parser.logs);
      
      console.log('ğŸ‰ ä¼šè¯åŠ è½½å®Œæˆ!');
      
      // æ›´æ–°ä¼šè¯é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
      const select = document.getElementById('sessionSelect');
      select.value = index;
      
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      document.getElementById('logViewer').scrollTop = 0;
    }

    // ä»æ—¥å¿—ä¸­è§£æè´¦å·ID
    function parseAccountId(logs) {
      // æŸ¥æ‰¾ AuthorizeRequest æ—¥å¿—
      let authLog = logs.find(log => 
        log.isNetworkLog && log.NetName === 'AuthorizeRequest' && 
        log.message.includes('"FID"')
      );
      
      if (authLog) {
        try {
          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç›´æ¥ä»æ¶ˆæ¯ä¸­æå– FID å€¼ï¼Œæ”¯æŒå¤šè¡Œ
          const match = authLog.message.match(/"FID"\s*:\s*"([^"]+)"/s);
          if (match && match[1]) {
            // å»é™¤æ‰€æœ‰æ¢è¡Œç¬¦å’Œå¤šä½™çš„ç©ºç™½å­—ç¬¦
            const accountId = match[1].replace(/[\n\r]+/g, '').trim();
            document.getElementById('accountId').textContent = accountId;
            return;
          }
        } catch (e) {
          console.error('Failed to parse AuthorizeRequest:', e);
        }
      }

      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼
      document.getElementById('accountId').textContent = '--';
    }

    // è§£æåŸºæœ¬ä¿¡æ¯
    function parseBasicInfo(content) {
      const lines = content.split('\n');
      basicInfo = {};  // æ¸…ç©ºæ—§ä¿¡æ¯
      detailInfo = {};
      
      for (const line of lines) {
        if (line.startsWith('[!@#]')) {
          break;
        }
        
        const colonIndex = line.indexOf(':');
        if (colonIndex !== -1) {
          const key = line.substring(0, colonIndex).trim();
          const value = line.substring(colonIndex + 1).trim();
          
          switch(key) {
            case 'version':
            case 'loginid':
            case 'TM':
            case 'platform':
            case 'lanid':
            case 'isOnline':
            case 'ä¸Šä¼ æ¥æº':
              basicInfo[key] = value;
              break;
            default:
              detailInfo[key] = value;
          }
        }
      }
      
      updateInfoDisplay();
    }

    // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
    function updateInfoDisplay() {
      document.getElementById('version').textContent = basicInfo.version || '--';
      document.getElementById('loginId').textContent = basicInfo.loginid || '--';
      document.getElementById('logTime').textContent = basicInfo.TM || '--';
      document.getElementById('platform').textContent = basicInfo.platform || '--';
      document.getElementById('language').textContent = basicInfo.lanid || '--';
      document.getElementById('source').textContent = basicInfo['ä¸Šä¼ æ¥æº'] || '--';
      const isOnline = basicInfo.isOnline === 'true' ? 'çº¿ä¸Š' : 
                      basicInfo.isOnline === 'false' ? 'å¼€å‘' : '--';
      document.getElementById('isOnline').textContent = isOnline;
    }

    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    function showDetailInfo() {
      const modal = document.getElementById('detailInfoModal');
      const detailDiv = document.getElementById('detailInfo');
      
      detailDiv.innerHTML = Object.entries(detailInfo)
        .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
        .join('\n');
      
      modal.style.display = 'block';
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // å…³é—­å¼¹çª—
    document.querySelector('.close').onclick = function() {
      document.getElementById('detailInfoModal').style.display = 'none';
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('detailInfoModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // ä¿®æ”¹ exportLogs å‡½æ•°
    function exportLogs() {
      // è·å–å½“å‰ä¼šè¯çš„åŸå§‹å†…å®¹
      const session = sessions[currentSessionIndex];
      if (!session) return;

      // 1. æ”¶é›†åŸºæœ¬ä¿¡æ¯è¡Œ
      const basicInfoLines = [];
      for (const line of session.lines) {
        // å¦‚æœé‡åˆ°æ—¥å¿—å¼€å§‹æ ‡è®°ï¼Œåœæ­¢æ”¶é›†åŸºæœ¬ä¿¡æ¯
        if (line.startsWith('[!@#]')) {
          break;
        }
        if (line.trim()) {
          basicInfoLines.push(line);
        }
      }

      // 2. è·å–å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ—¥å¿—
      const filteredLogs = filterLogs();  // ç›´æ¥ä½¿ç”¨ filterLogs çš„è¿”å›å€¼
      
      // 3. æ„å»ºå¯¼å‡ºå†…å®¹
      let exportContent = [];
      
      // æ·»åŠ åŸºæœ¬ä¿¡æ¯
      exportContent.push('# åŸºæœ¬ä¿¡æ¯');
      exportContent.push(...basicInfoLines);
      exportContent.push('');  // ç©ºè¡Œåˆ†éš”
      
      // æ·»åŠ ç­›é€‰æ¡ä»¶ä¿¡æ¯
      const selectedLevel = logLevelSelect.value;
      const moduleKeyword = moduleFilter.value.toLowerCase();
      const selectedType = typeFilter.value;
      const contentKeyword = contentFilter.value.trim().toLowerCase();
      const showOnlyMatches = document.getElementById('showOnlyMatches').checked;

      exportContent.push('# å¯¼å‡ºæ¡ä»¶');
      exportContent.push(`å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`);
      exportContent.push(`æ—¥å¿—ç±»å‹: ${selectedType === 'All' ? 'å…¨éƒ¨' : (selectedType === 'Network' ? 'ç½‘ç»œæ—¥å¿—' : 'æ™®é€šæ—¥å¿—')}`);
      exportContent.push(`æ—¥å¿—ç­‰çº§: ${selectedLevel === 'All' ? 'å…¨éƒ¨' : selectedLevel}`);
      if (moduleKeyword) {
        exportContent.push(`æ¨¡å—ç­›é€‰: ${moduleKeyword}`);
      }
      if (contentKeyword) {
        exportContent.push(`å†…å®¹ç­›é€‰: ${contentKeyword}`);
        if (showOnlyMatches) {
          exportContent.push('ä»…æ˜¾ç¤ºåŒ¹é…å†…å®¹: æ˜¯');
        }
      }
      exportContent.push(`å¯¼å‡ºæ•°é‡: ${filteredLogs.length} æ¡`);
      exportContent.push('');  // ç©ºè¡Œåˆ†éš”
      
      // æ·»åŠ æ—¥å¿—å†…å®¹
      exportContent.push('# æ—¥å¿—å†…å®¹');
      exportContent.push('[!@#][Log]: start.....');  // æ·»åŠ æ—¥å¿—å¼€å§‹æ ‡è®°
      
      // ä½¿ç”¨åŸå§‹è¡Œå¯¼å‡ºæ—¥å¿—
      filteredLogs.forEach(log => {
        exportContent.push(log.rawContent);
      });
      
      // 4. è·å–æ–‡ä»¶å
      let baseFileName;
      const logFile = document.getElementById('logFile').files[0];
      if (logFile) {
        baseFileName = logFile.name.replace(/\.[^/.]+$/, "");
      } else {
        const logUrl = getLogUrlFromParams();
        if (logUrl) {
          const urlParts = logUrl.split('/');
          baseFileName = urlParts[urlParts.length - 1].replace(/\.[^/.]+$/, "");
        } else {
          baseFileName = 'log_export';
        }
      }
      
      // æ„å»ºå¯¼å‡ºæ–‡ä»¶åï¼šåŸæ–‡ä»¶å+ä¼šè¯å·+ç­›é€‰æ¡ä»¶
      const sessionNumber = currentSessionIndex + 1;
      const filterInfo = [];
      if (selectedType !== 'All') filterInfo.push(selectedType);
      if (selectedLevel !== 'All') filterInfo.push(selectedLevel);
      if (moduleKeyword) filterInfo.push('filtered');
      if (contentKeyword && showOnlyMatches) filterInfo.push('searched');
      
      const exportFileName = `${baseFileName}_session${sessionNumber}${filterInfo.length ? '_' + filterInfo.join('_') : ''}.txt`;
      
      // 5. å¯¼å‡ºæ–‡ä»¶
      const content = exportContent.join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = exportFileName;
      
      document.body.appendChild(a);
      a.click();
      
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // ä¸‹è½½åŸå§‹æ–‡ä»¶
    function downloadOriginalFile() {
      const logUrl = getLogUrlFromParams();
      if (logUrl) {
        console.log("logUrl",logUrl);
        const urlParts = logUrl.split('/');
        console.log("urlParts",urlParts);
        const fileName = urlParts[urlParts.length - 1];
        console.log("fileName",fileName);
        // åˆ›å»ºä¸€ä¸ªéšè—çš„ a æ ‡ç­¾æ¥è§¦å‘ä¸‹è½½
        const a = document.createElement('a');
        a.href = logUrl;
        // a.download = fileName;  // å¯ç”¨ä¸‹è½½å±æ€§
        a.target = '_blank';  // æ³¨é‡Šæ‰ï¼Œå› ä¸ºdownloadå’Œtarget='_blank'å†²çª
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
  </script>
</body>
</html>