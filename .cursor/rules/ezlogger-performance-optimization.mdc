---
description: "EZ Logger æ€§èƒ½ä¼˜åŒ–å’Œé›¶å¼€é”€å®ç°ç»†èŠ‚"
globs: Runtime/**/*.cs
---

# EZ Logger æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## é›¶å¼€é”€å®ç°åŸç†

### 1. æ¡ä»¶æ—¥å¿—è®°å½•å™¨æœºåˆ¶
EZ Loggerçš„æ ¸å¿ƒæ€§èƒ½ç‰¹æ€§æ˜¯é€šè¿‡æ¡ä»¶æ—¥å¿—è®°å½•å™¨å®ç°çš„ï¼š

```csharp
// å½“çº§åˆ«è¢«ç¦ç”¨æ—¶ï¼Œè¿™ä¸ªå±æ€§è¿”å›null
public static ConditionalLogger Log
{
    get
    {
        // åªæœ‰åœ¨çº§åˆ«å˜åŒ–æ—¶æ‰åˆ·æ–°ç¼“å­˜
        var currentLevels = EZLoggerManager.Instance.EnabledLevels;
        if (currentLevels != _lastCheckedLevels)
        {
            RefreshCachedLoggers(currentLevels);
        }
        return _cachedL; // ç¦ç”¨æ—¶ä¸ºnullï¼Œå¯ç”¨æ—¶ä¸ºå®ä¾‹
    }
}
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤åˆ›å»ºå¯¹è±¡
- çº§åˆ«å˜åŒ–æ—¶æ‰åˆ·æ–°ï¼Œé¿å…é¢‘ç¹æ£€æŸ¥
- ç¦ç”¨æ—¶è¿”å›nullï¼Œé…åˆ`?.`æ“ä½œç¬¦å®ç°é›¶å¼€é”€

### 2. C# ç©ºæ¡ä»¶æ“ä½œç¬¦çš„å¨åŠ›
```csharp
// å½“EZLog.Logè¿”å›nullæ—¶ï¼Œæ•´ä¸ªè¡¨è¾¾å¼çŸ­è·¯ï¼Œå‚æ•°ä¸ä¼šè¢«è®¡ç®—
EZLog.Log?.Log("tag", ExpensiveOperation());

// ç­‰æ•ˆäºä¸‹é¢çš„ä»£ç ï¼Œä½†æ›´ç®€æ´
var logger = EZLog.Log;
if (logger != null)
{
    logger.Log("tag", ExpensiveOperation()); // åªæœ‰è¿™æ—¶æ‰è®¡ç®—å‚æ•°
}
```

### 3. ç¼“å­˜ä¼˜åŒ–ç­–ç•¥
```csharp
// é¿å…é¢‘ç¹çš„çº§åˆ«æ£€æŸ¥
private static LogLevel _lastCheckedLevels = LogLevel.None;
private static ConditionalLogger _cachedL;

// åªåœ¨çº§åˆ«çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°ç¼“å­˜
if (currentLevels != _lastCheckedLevels)
{
    RefreshCachedLoggers(currentLevels);
}
```

## æ€§èƒ½å…³é”®ç‚¹

### 1. æ–¹æ³•å†…è”ä¼˜åŒ–
```csharp
[MethodImpl(MethodImplOptions.AggressiveInlining)]
public void Log(string tag, string message)
{
    // å…³é”®è·¯å¾„æ–¹æ³•æ ‡è®°ä¸ºå†…è”
    _logger.Log(LogLevel.Log, tag, message);
}
```

### 2. é¿å…è£…ç®±å’Œå­—ç¬¦ä¸²åˆ†é…
```csharp
// âœ… å¥½çš„åšæ³•ï¼šå»¶è¿Ÿå­—ç¬¦ä¸²æ„å»º
EZLog.Log?.Log("Performance", () => $"Value: {expensiveValue}");

// âŒ é¿å…ï¼šå³ä½¿ç¦ç”¨ä¹Ÿä¼šåˆ†é…å­—ç¬¦ä¸²
EZLog.Log?.Log("Performance", $"Value: {expensiveValue}");
```

### 3. å¯¹è±¡æ± åŒ–
```csharp
// ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GCå‹åŠ›
private readonly ObjectPool<StringBuilder> _stringBuilderPool;
private readonly ObjectPool<LogMessage> _logMessagePool;

// è·å–å¯¹è±¡æ—¶ä»æ± ä¸­å–ï¼Œç”¨å®Œåå½’è¿˜
var sb = _stringBuilderPool.Get();
try
{
    // ä½¿ç”¨StringBuilder
}
finally
{
    _stringBuilderPool.Return(sb);
}
```

### 4. å¼‚æ­¥å¤„ç†ä¼˜åŒ–
```csharp
// ä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—å®ç°å¼‚æ­¥å†™å…¥
private readonly ThreadSafeQueue<LogMessage> _messageQueue;

// å†™å…¥çº¿ç¨‹ä¸“é—¨å¤„ç†IOæ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
private void WriteThreadProc()
{
    while (!_cancellationToken.IsCancellationRequested)
    {
        if (_messageQueue.TryDequeue(out var message))
        {
            WriteToAppenders(message);
        }
    }
}
```

## æ€§èƒ½æµ‹è¯•æ¨¡å¼

### 1. åŸºå‡†æµ‹è¯•ä»£ç 
```csharp
public void PerformanceBenchmark()
{
    const int iterations = 100000;
    
    // æµ‹è¯•ç¦ç”¨çº§åˆ«çš„æ€§èƒ½ï¼ˆåº”è¯¥æ¥è¿‘é›¶å¼€é”€ï¼‰
    EZLog.DisableAll();
    var stopwatch = Stopwatch.StartNew();
    
    for (int i = 0; i < iterations; i++)
    {
        EZLog.Log?.LogFormat("Benchmark", "Message {0}", i);
    }
    
    stopwatch.Stop();
    var disabledTime = stopwatch.ElapsedMilliseconds;
    
    // æµ‹è¯•å¯ç”¨çº§åˆ«çš„æ€§èƒ½
    EZLog.EnableAll();
    stopwatch.Restart();
    
    for (int i = 0; i < iterations; i++)
    {
        EZLog.Log?.LogFormat("Benchmark", "Message {0}", i);
    }
    
    stopwatch.Stop();
    var enabledTime = stopwatch.ElapsedMilliseconds;
    
    // ç¦ç”¨æ—¶åº”è¯¥æ¯”å¯ç”¨æ—¶å¿«å¾ˆå¤šå€
    Debug.Log($"ç¦ç”¨: {disabledTime}ms, å¯ç”¨: {enabledTime}ms, æ¯”ç‡: {enabledTime/(float)disabledTime:F1}x");
}
```

### 2. å†…å­˜åˆ†é…æµ‹è¯•
```csharp
public void MemoryAllocationTest()
{
    // è®°å½•æµ‹è¯•å‰çš„å†…å­˜ä½¿ç”¨
    var beforeMemory = GC.GetTotalMemory(true);
    
    // æ‰§è¡Œå¤§é‡ç¦ç”¨çº§åˆ«çš„æ—¥å¿—è°ƒç”¨
    EZLog.DisableAll();
    for (int i = 0; i < 10000; i++)
    {
        EZLog.Log?.LogFormat("Memory", "Test message {0} with value {1}", i, Random.value);
    }
    
    // æ£€æŸ¥å†…å­˜å¢é•¿ï¼ˆåº”è¯¥æ¥è¿‘é›¶ï¼‰
    var afterMemory = GC.GetTotalMemory(true);
    var allocated = afterMemory - beforeMemory;
    
    Debug.Log($"ç¦ç”¨çº§åˆ«ä¸‹åˆ†é…å†…å­˜: {allocated} bytes");
}
```

## æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### âœ… å¿…é¡»éµå®ˆçš„æ€§èƒ½åŸåˆ™
1. **é›¶å¼€é”€è¦æ±‚**: ç¦ç”¨çº§åˆ«æ—¶ä¸èƒ½æœ‰ä»»ä½•æ€§èƒ½å¼€é”€
2. **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤åˆ›å»ºå¯¹è±¡å’Œè®¡ç®—
3. **æ–¹æ³•å†…è”**: å…³é”®è·¯å¾„ä½¿ç”¨`AggressiveInlining`
4. **å¼‚æ­¥å¤„ç†**: IOæ“ä½œä¸èƒ½é˜»å¡ä¸»çº¿ç¨‹
5. **å¯¹è±¡æ± åŒ–**: é‡ç”¨StringBuilderç­‰ä¸´æ—¶å¯¹è±¡

### âŒ æ€§èƒ½é™·é˜±é¿å…
1. **é¿å…è£…ç®±**: ä¸è¦ä¼ é€’å€¼ç±»å‹åˆ°objectå‚æ•°
2. **é¿å…é—­åŒ…**: å°å¿ƒlambdaè¡¨è¾¾å¼çš„æ•è·
3. **é¿å…åå°„**: è¿è¡Œæ—¶ä¸ä½¿ç”¨åå°„æ“ä½œ
4. **é¿å…å­—ç¬¦ä¸²è¿æ¥**: ä½¿ç”¨StringBuilderæˆ–æ’å€¼
5. **é¿å…é¢‘ç¹åˆ†é…**: ä½¿ç”¨å¯¹è±¡æ± å’Œç¼“å­˜

### ğŸ” æ€§èƒ½ç›‘æ§ç‚¹
1. **è°ƒç”¨é¢‘ç‡**: ç›‘æ§é«˜é¢‘è°ƒç”¨è·¯å¾„çš„æ€§èƒ½
2. **å†…å­˜åˆ†é…**: ä½¿ç”¨Profileræ£€æŸ¥GCåˆ†é…
3. **çº¿ç¨‹ç«äº‰**: ç›‘æ§å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ€§èƒ½
4. **IOæ€§èƒ½**: æµ‹è¯•æ–‡ä»¶å’Œç½‘ç»œè¾“å‡ºå™¨çš„ååé‡